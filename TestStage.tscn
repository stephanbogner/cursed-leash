[gd_scene load_steps=14 format=2]

[ext_resource path="res://TestStage.gd" type="Script" id=1]
[ext_resource path="res://Person.tscn" type="PackedScene" id=2]
[ext_resource path="res://Dog.tscn" type="PackedScene" id=3]
[ext_resource path="res://Dog.gd" type="Script" id=4]
[ext_resource path="res://TrashCan.tscn" type="PackedScene" id=5]
[ext_resource path="res://Person.gd" type="Script" id=6]
[ext_resource path="res://ScreenShake.tscn" type="PackedScene" id=7]
[ext_resource path="res://Ground.tscn" type="PackedScene" id=8]
[ext_resource path="res://Leash.png" type="Texture" id=9]

[sub_resource type="Shader" id=1]
code = "// Type of shader https://docs.godotengine.org/en/3.0/tutorials/shading/shading_language.html#shader-types
shader_type canvas_item;
uniform float intensity = 0.0;

void fragment() {
	vec4 current_colorVec4 = textureLod(SCREEN_TEXTURE, SCREEN_UV, 0.0);
	vec3 current_color = vec3(current_colorVec4[0], current_colorVec4[1], current_colorVec4[2]);
	
    COLOR = texture(TEXTURE, UV);
    float avg = (COLOR.r + COLOR.g + COLOR.b) / 3.0;
	vec3 new_color = vec3(avg) * intensity + current_color * (1.0 - intensity);
	COLOR.rgb = new_color.rgb;
}"

[sub_resource type="ShaderMaterial" id=2]
shader = SubResource( 1 )
shader_param/intensity = 0.0

[sub_resource type="Shader" id=3]
code = "/*
	Glitch Effect Shader by Yui Kinomoto @arlez80

	MIT License
*/

shader_type canvas_item;

// 振動の強さ
//uniform float shake_power = 0.03;
uniform float shake_power = 0;
// 振動率
//uniform float shake_rate : hint_range( 0.0, 1.0 ) = 0.2;
uniform float shake_rate : hint_range( 0.0, 1.0 ) = 0;
// 振動速度
uniform float shake_speed = 5.0;
// 振動ブロックサイズ
uniform float shake_block_size = 30.5;
// 色の分離率
uniform float shake_color_rate : hint_range( 0.0, 1.0 ) = 0.01;

float random( float seed )
{
	return fract( 543.2543 * sin( dot( vec2( seed, seed ), vec2( 3525.46, -54.3415 ) ) ) );
}

void fragment( )
{
	float enable_shift = float(
		random( trunc( TIME * shake_speed ) )
	<	shake_rate
	);

	vec2 fixed_uv = SCREEN_UV;
	fixed_uv.x += (
		random(
			( trunc( SCREEN_UV.y * shake_block_size ) / shake_block_size )
		+	TIME
		) - 0.5
	) * shake_power * enable_shift;

	vec4 pixel_color = textureLod( SCREEN_TEXTURE, fixed_uv, 0.0 );
	pixel_color.r = mix(
		pixel_color.r
	,	textureLod( SCREEN_TEXTURE, fixed_uv + vec2( shake_color_rate, 0.0 ), 0.0 ).r
	,	enable_shift
	);
	pixel_color.b = mix(
		pixel_color.b
	,	textureLod( SCREEN_TEXTURE, fixed_uv + vec2( -shake_color_rate, 0.0 ), 0.0 ).b
	,	enable_shift
	);
	COLOR = pixel_color;
}"

[sub_resource type="ShaderMaterial" id=4]
shader = SubResource( 3 )
shader_param/shake_power = 0.0
shader_param/shake_rate = 0.0
shader_param/shake_speed = 5.0
shader_param/shake_block_size = 30.5
shader_param/shake_color_rate = 0.01

[node name="TestStage" type="Node2D"]
script = ExtResource( 1 )

[node name="Ground" parent="." instance=ExtResource( 8 )]
position = Vector2( 254.885, 6.2677 )

[node name="Person" parent="." instance=ExtResource( 2 )]
position = Vector2( 200.653, 377.998 )
collision_mask = 3
script = ExtResource( 6 )

[node name="Dog" parent="." instance=ExtResource( 3 )]
position = Vector2( 625.496, 314.519 )
collision_layer = 2
collision_mask = 3
script = ExtResource( 4 )

[node name="TrashCan" parent="." instance=ExtResource( 5 )]
position = Vector2( 250.48, 248.769 )
collision_layer = 7
collision_mask = 7
script = null

[node name="TrashCan2" parent="." instance=ExtResource( 5 )]
position = Vector2( 291.751, 204.222 )
collision_layer = 7
collision_mask = 7
script = null

[node name="TrashCan3" parent="." instance=ExtResource( 5 )]
position = Vector2( 382.482, 239.597 )
collision_layer = 7
collision_mask = 7
script = null

[node name="TrashCan4" parent="." instance=ExtResource( 5 )]
position = Vector2( 360.536, 146.901 )
collision_layer = 7
collision_mask = 7
script = null

[node name="Cam" type="Camera2D" parent="."]
current = true
zoom = Vector2( 3, 3 )
smoothing_enabled = true

[node name="ScreenShake" parent="Cam" instance=ExtResource( 7 )]

[node name="ShaderColor" type="Sprite" parent="Cam"]
visible = false
material = SubResource( 2 )
position = Vector2( 9.00704, 11.6027 )
scale = Vector2( 629.085, 100.308 )
texture = ExtResource( 9 )

[node name="ShaderGlitch" type="Sprite" parent="Cam"]
material = SubResource( 4 )
position = Vector2( -18.2411, 2.02673 )
scale = Vector2( 550.259, 82.0715 )
texture = ExtResource( 9 )

[node name="SoulSwitchTimer" type="Timer" parent="."]

[connection signal="timeout" from="SoulSwitchTimer" to="." method="_on_SoulSwitchTimer_timeout"]
[connection signal="timeout" from="SoulSwitchTimer" to="Person" method="_on_SoulSwitchTimer_timeout"]
[connection signal="timeout" from="SoulSwitchTimer" to="Dog" method="_on_SoulSwitchTimer_timeout"]
